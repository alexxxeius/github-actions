name: CI CD Non-Prod

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        type: choice
        default: 'dev'
        description: 'Environment name'
        required: true
        options:
          - alpha
          - staging
          - dev

jobs:
  get_vars:
    name: Expose variables
    uses: ./.github/workflows/vars.yml
    with:
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}

  deploy:
    name: Deploy non-production
    needs: get_vars
    uses: ./.github/workflows/deploy.yml
    if: ${{ inputs.ENVIRONMENT != 'production' }}
    with:
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
      SSH_HOST: ${{ needs.get_vars.outputs.DEPLOY_TO }}
      FOLDER_PATH: ${{ needs.get_vars.outputs.FOLDER_PATH }}
    secrets: inherit

  notify:
    name: Notify on Slack
    if: always()
    needs: deploy
    uses: ./.github/workflows/slack-event.yml
    with:
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
      SLACK_CHANNEL_ID: c8-be-notifications
      STATUS: ${{ needs.deploy.result }}